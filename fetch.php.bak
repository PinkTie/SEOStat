<?php
require_once('lib/gapi.class.php');
require_once('lib/class.googlepr.php');
require_once('inc/db.php');
require_once('inc/helper.php');

if (isset($_GET['id'])) {
	$id = $_GET['id'];	
} else {
	die("Please specify profile ID..");
}

if ($id == 'all') {
	$accounts = getProfiles();
} else {
	$accounts = getProfiles($id);
}

$fetchGA = true;
$fetchYahoo = true;
$fetchBacklinkWatch = true;
$fetchSEOPro = true;
$fetchGoogleIdx = true;
$fetchBingIdx = true;
$fetchGooglePR = true;
$fetchAlexa = true;
$fetchFacebook = true;
$fetchTwitter = true;
$saveToDB = true;

echo 'Start fetch: '.date("Y-m-d H:i:s").'<br>';

foreach ($accounts as $account) {
	echo 'Get stat for: '.$account['url'].'<br>';
	
	if ($fetchGA) {
		if ($account['ga_username'] != '') {
			$ga = new gapi($account['ga_username'],$account['ga_passwd']);
			$fromDate = date("Y-m-d", strtotime('-6 days'));
			$toDate = date("Y-m-d");
			$ga->requestReportData($account['ga_profileid'], array('week','date','hour'), array('pageviews','visits'), array('date'), null, $fromDate, $toDate, 1, 1000);
			foreach($ga->getResults() as $result) {
				//01 20100101 00
				saveGAStat($account,$result);		
			}	
		}
	}	
	$result = array();
	
	if ($fetchYahoo) {
		//check backlink
		//http://siteexplorer.search.yahoo.com/search?p=www.waytodeal.com&fr=sfp&bwm=i
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://siteexplorer.search.yahoo.com/search?p=".$account['url']."&fr=sfp&bwm=i");
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		$tempArr = explode('">Pages (', $buf2);
		$tempArr = explode(')<i', $tempArr[1]);
	   $indexedPage = str_replace(',', '', $tempArr[0]);
		
		$tempArr = explode('Inlinks (',$tempArr[1]);
		$tempArr = explode('<i class',$tempArr[1]);
		$backlink = str_replace(',', '', $tempArr[0]);
		
		echo 'yahoo index: '.$indexedPage.'<br>yahoo backlink: '.$backlink.'<br>';
	}
		
	$result['yindex'] = $indexedPage;
	$result['ybacklink'] = $backlink;
	
	if ($fetchBacklinkWatch) {
		//check backlinkwatch.com
		$ch = getCURLResource();
		$page = 'http://www.backlinkwatch.com/index.php';
		curl_setopt($ch, CURLOPT_URL, $page);
		curl_setopt($ch, CURLOPT_POST, true);
		curl_setopt($ch, CURLOPT_POSTFIELDS, "backlinkurl=".urlencode('http://'.$account['url'])."&submit=+Check+Backlinks+");
	
		$buf2 = curl_exec ($ch);
	
		curl_close($ch);
		
		$tempArr = explode('>Total Backlinks<',$buf2);
	   $tempArr = explode('<td class="row"align="center" width="671"  >',$tempArr[1]);
	   $tempArr = explode('&nbsp;</td>',$tempArr[1]);
		$backlinkwatch = $tempArr[0];
		
		echo 'Backlinkwatch: '.$backlinkwatch.'<br>';
	}
		
	$result['blwbacklink'] = $backlinkwatch;
	
	if ($fetchSEOPro) {
		//check backlinkcheck.com
		//http://seopro.com.au/free-seo-tools/new/iframes/backlinks.php?bdomain=www.waytodeal.com&method=yahoo&links=1
		$ch = getCURLResource();		
		//http://seopro.com.au/free-seo-tools/link-checker/
		//get cookie
		curl_setopt($ch, CURLOPT_URL, "http://seopro.com.au/free-seo-tools/link-checker/");
		curl_exec ($ch);
		curl_close($ch);
		
		$ch = getCURLResource();		
		curl_setopt($ch, CURLOPT_URL, "http://seopro.com.au/free-seo-tools/new/iframes/backlinks.php?bdomain=".$account['url']."&method=yahoo&links=1");
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		//<script>parent.$('#results').html('<h3>Results (Total 301994)</h3><div id="pager-top"></div><br/><table
		
		$tempArr = explode('<h3>Results (Total ',$buf2);
		$tempArr = explode(')</h3><div id="pager-top"></div><br/>',$tempArr[1]);
		
		$backlinkcheck = $tempArr[0];
		
		echo 'Backlinkcheck: '.$backlinkcheck.'<br>';
	}
	$result['blcbacklink'] = $backlinkcheck;
	
	/*
	$ch = getCURLResource();
	curl_setopt($ch, CURLOPT_URL, "http://www.backlinkcheck.com/popular.pl?url1=http%3A%2F%2F".$account['url']."&url2=&url3=");
	$buf2 = curl_exec ($ch);
	curl_close($ch);
	
	$tempArr = explode('>'.$account['url'].'</a> are <b>',$buf2);
	$tempArr = explode('</b> - Alexa <',$tempArr[1]);
	
	$backlinkcheck = $tempArr[0];
	
	echo 'Backlinkcheck: '.$backlinkcheck.'<br>';
	
	$result['blcbacklink'] = $backlinkcheck;
	*/
	
	if ($fetchGoogleIdx) {
		//check indexed page google
		//http://www.google.com/search?hl=en&lr=&q=site%3Awww.waytodeal.com&btnG=Search
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://www.google.com/search?hl=en&lr=&q=site%3A".$account['url']."&btnG=Search");
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		$arrTemp = explode('About ',$buf2);
		$arrTemp = explode(' results',$arrTemp[1]);
		
		$googleidxpage = str_replace(',', '', $arrTemp[0]);
		
		echo 'Google indexed page: '.$googleidxpage.'<br>';
	}
		
	$result['gindex'] = $googleidxpage;

	if ($fetchBingIdx) {
		//bing index
		//http://www.bing.com/search?q=site%3Awww.waytodeal.com&FORM=QBRE&format=xml
		//http://www.bing.com/search?q=site%3Awww.waytodeal.com&go=&form=QBRE
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://www.bing.com/search?q=site%3A".$account['url']."&go&FORM=QBRE");
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		$tempArr = explode('<h1>All Results</h1><span class="sb_count" id="count">',$buf2);
		$tempArr = explode(' of ',$tempArr[1]);
		$tempArr = explode(' results',$tempArr[1]);
		$bingindex = str_replace(',', '', $tempArr[0]);
		
		//$xml=xml2ary($buf2);
		//$bingindex = $xml['searchresult']['_c']['documentset']['_a']['total']; 
		
		echo 'Bing indexed page: '.$bingindex.'<br>';
	}

	$result['bingindex'] = $bingindex;
	
	if ($fetchAlexa) {
		//alexa rank
		//http://xml.alexa.com/data?cli=10&url=waytodeal.com
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://xml.alexa.com/data?cli=10&url=".$account['url']);
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		$xml=xml2ary($buf2);
		$alexarank = $xml['ALEXA']['_c']['SD']['_c']['POPULARITY']['_a']['TEXT']; 
		
		echo 'Alexa rank: '.$alexarank.'<br>';
	}
	
	$result['alexarank'] = $alexarank;

	if ($fetchGooglePR) {
		$gpr = new GooglePR();
		$gpr->userAgent = $_SERVER["HTTP_USER_AGENT"];
		$gpr->cacheDir = dirname(__FILE__)."/prcache";
		$gpr->maxCacheAge = 86400;
		$gpr->useCache = false;
		$googlepr = $gpr->GetPR($account['url']);
		echo 'Google pagerank: '.$googlepr.'<br>';	
	}
	
	$result['grank'] = $googlepr;
	
	if ($saveToDB) {
		saveIndexStat($account,$result);
		saveBacklinkStat($account,$result);
		saveRankStat($account,$result);
	}
		
	//get facebook page stat
	if ($fetchFacebook && $account['fb_pageid'] != '') {
		facebookLogin($account['ga_username'], $account['ga_passwd']);

		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://www.facebook.com/business/insights/json.php?id=".$account['fb_pageid']."&reports=1");
		$buf2 = curl_exec ($ch);
		curl_close($ch);

		//$tempArr = explode('or (;;);',$buf2);
		//$tempArr = json_decode($tempArr[1], true);
		
		//echo '<pre>'.$buf2.'</pre>';

		$result = array();
		
		$tempArr = explode('{"Total Interactions":[[',$buf2);
		$tempArr = explode(']]},{"Comments"',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result['Total Interactions'] = $tempArr;
		
		$tempArr = explode('{"Comments":[[',$buf2);
		$tempArr = explode(']]},{"Wall Posts"',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result['Comments'] = $tempArr;
		
		$tempArr = explode('{"Wall Posts":[[',$buf2);
		$tempArr = explode(']]},{"Likes"',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result['Wall Posts'] = $tempArr;
		
		$tempArr = explode('{"Likes":[[',$buf2);
		$tempArr = explode(']]},',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result['Likes'] = $tempArr;
		
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://www.facebook.com/business/insights/json.php?id=".$account['fb_pageid']."&reports=2");
		$buf2 = curl_exec ($ch);
		curl_close($ch);

		$result2 = array();

		$tempArr = explode('{"Total Fans":[[',$buf2);
		$tempArr = explode(']]},{"Hidden From News Feed"',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result2['Total Fans'] = $tempArr;
		
		$tempArr = explode('{"Hidden From News Feed":[[',$buf2);
		$tempArr = explode(']]},',$tempArr[1]);
		$tempArr = explode('],[',$tempArr[0]);
		for ($i = 0; $i < sizeof($tempArr); $i++) {
			$tempArr[$i] = explode(',',$tempArr[$i]);
		}
		$result2['Unsubscribed Fans'] = $tempArr;
		

		//$tempArr1 = explode('or (;;);',$buf2);
		//$tempArr1 = json_decode($tempArr1[1], true);
		
		//print_r($tempArr1);
		
		//print_r($result);
		//echo '<br>';
		//print_r($result2);
		//echo '<br>';
		
		saveFacebookStat($account,$result,$result2);	
		
		facebookLogout();
	}

	if ($fetchTwitter && $account['twitter_page'] != '') {
		$ch = getCURLResource();
		curl_setopt($ch, CURLOPT_URL, "http://twitter.com/".$account['twitter_page']);
		$buf2 = curl_exec ($ch);
		curl_close($ch);
		
		$twitterData = array();
		$tempArr = explode('<span id="following_count" class="stats_count numeric">',$buf2);
		$tempArr = explode(' </span>',$tempArr[1]);
		$twitterData['following'] = str_replace(',','',trim($tempArr[0]));
		$tempArr = explode('<span id="follower_count" class="stats_count numeric">',$buf2);
		$tempArr = explode(' </span>',$tempArr[1]);
		$twitterData['follower'] = str_replace(',','',trim($tempArr[0]));
		$tempArr = explode('<span id="lists_count" class="stats_count numeric">',$buf2);
		$tempArr = explode('</span>',$tempArr[1]);
		$twitterData['listed'] = str_replace(',','',trim($tempArr[0]));
		$tempArr = explode('<span id="update_count" class="stat_count">',$buf2);
		$tempArr = explode('</span>',$tempArr[1]);
		$twitterData['tweets'] = str_replace(',','',trim($tempArr[0]));
		
		print_r($twitterData);
		echo '<br>';
		saveTwitterStat($account,$twitterData);		
	}
	
}

echo 'End fetch: '.date("Y-m-d H:i:s").'<br>';
?>